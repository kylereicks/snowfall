!function(a,b,c,d,e){"use strict";{var f=d.Model.extend({defaults:{itemId:"",type:"aside",parentId:"0",parentType:"object",level:0,order:0,key:"",value:""},initialize:function(){this.get("itemId")?this.cid=this.get("itemId"):this.set({itemId:this.cid})}}),g=d.Collection.extend({model:f,comparator:function(a){return[a.get("level"),a.get("order")]}}),h={sortable:function(a){a.$el.children("ul, ol").sortable({update:function(){a.updateOrder()},stop:function(){a.$el.find("textarea").each(function(){var a=c(this);a.hasClass("wp-editor-area")&&tinyMCE.execCommand("mceAddEditor",!0,a.attr("id"))})},start:function(){a.$el.find("textarea").each(function(){var a=c(this),b="";a.hasClass("wp-editor-area")&&(b=tinyMCE.activeEditor.getContent(),tinyMCE.execCommand("mceRemoveEditor",!1,a.attr("id")),a.val(b))})},handle:".sort-handle"})}},i=d.View.extend({tagName:"li",template:null,events:{"click span.delete":"remove","change input":"updateModel","change textarea":"updateModel","click button.add-from-url":"addFromUrl","click button.select-image":"selectMedia","click button.select-gallery":"selectMedia","click button.select-video":"selectMedia","click button.select-audio":"selectMedia"},initialize:function(){e.bindAll(this,"render","unrender","removeTree","remove","updateModel","addFromUrl","selectMedia","updateOrder"),c(this.el).attr("id",this.model.get("itemId")),this.template=e.template(c("#"+this.model.get("parentType")+"-"+this.model.get("type")).html()),this.model.bind("remove",this.unrender),this.model.bind("updateModel",this.updateModel)},render:function(){return this.$el.html(this.template(this.model.toJSON())),h.sortable(this),this},unrender:function(){c(this.el).remove()},updateOrder:function(){e(this.model.collection.models).each(function(a){a.set({order:c("li#"+a.get("itemId")).index()})},this)},removeTree:function(a){e(a.collection.where({parentId:a.get("itemId")})).each(function(a){this.removeTree(a)},this),a.destroy()},remove:function(){this.removeTree(this.model)},addFromUrl:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.model.set({value:null}),b.$el.find(".image-preview").attr("src","http://placehold.it/100x100"),b.$el.find(".audio-preview, .video-preview").html(""),b.$el.find(".value").removeAttr("disabled")},selectMedia:function(a){a.preventDefault(),a.stopPropagation(),g&&g.detach();var b=this,c=b.model.get("type"),d=[],g=null;switch(b.$el.find(".value").val(""),b.$el.find(".value").attr("disabled","disabled"),c){case"image":d.push(new wp.media.controller.Library({title:"Images",library:wp.media.query({type:"image"})}));break;case"gallery":d.push(new wp.media.controller.Library({title:"Images",multiple:"add",library:wp.media.query({type:"image"})}));break;case"video":d.push(new wp.media.controller.Library({title:"Videos",library:wp.media.query({type:"video"})}));break;case"audio":d.push(new wp.media.controller.Library({title:"Audio",library:wp.media.query(e.defaults({type:"audio"},this.library))}))}g=wp.media({states:d}),g.on("select",function(){var a=g.state().get("selection"),d=[],e=null,h=0,i=0;if(a.each(function(a){delete a.attributes.compat,delete a.attributes.editLink,delete a.attributes.nonces,d.push(a.attributes)}),"gallery"===c)for(h=0,i=d.length;i>h;h++)e=new f({type:"image",parentId:b.model.get("itemId"),parentType:"gallery",level:b.model.get("level")+1,value:[d[h]]}),b.model.collection.add(e);else"image"===c?(b.model.set({value:d}),console.log(d),b.$el.find(".image-preview").attr("src",d[0].sizes.thumbnail.url)):(b.model.set({value:d}),b.$el.find(".audio-preview, .video-preview").html(d[0].filename))}),g.open()},updateModel:function(){switch(this.model.get("type")){case"section":this.model.set({key:this.$el.find(".key").val()});break;case"html":this.model.set({value:this.$el.find(".value").val()});break;case"image":case"video":case"audio":"disabled"!==this.$el.find(".value").attr("disabled")&&this.model.set({value:this.$el.find(".value").val()})}}}),j=d.View.extend({el:c("#snowfall-editor"),events:{"click button.add-item":"addItem"},initialize:function(){e.bindAll(this,"render","addItem","appendItem","updateContent","updateOrder");this.collection=c("#content").val()?new g(JSON.parse(c("#content").val())):new g,this.collection.bind("add",this.appendItem),this.collection.bind("change reset add remove",this.updateContent),this.render(),h.sortable(this)},render:function(){var a=this,b=["section","aside","image","video","audio","gallery","html"];c(this.el).append("<ul></ul>"),c(this.el).append(this.getButtonsHtml(b)),e(this.collection.models).each(function(b){a.appendItem(b)},this)},getButtonsHtml:function(a){var b="",d=e.template(c("#button-add").html());return e(a).each(function(a){b+=d({item:a})}),b?'<span class="plus-icon"></span>'+b:b},addItem:function(a){a.preventDefault();var b="LI"===a.target.parentElement.tagName?this.collection.findWhere({itemId:a.target.parentElement.id}):!1,c=new f({type:a.target.className.match(/item-([^\s]+)/)[1],parentId:b?b.get("itemId"):"0",parentType:b?b.get("type"):"object",level:b?b.get("level")+1:0});this.collection.add(c)},appendItem:function(b){var d=new i({model:b}),f=null;if("0"!==b.get("parentId")?c("#"+b.get("parentId")+">ul, #"+b.get("parentId")+">ol").append(d.render().el):this.$el.children("ul").append(d.render().el),b.set({order:d.$el.index()}),d.$el.find("textarea").hasClass("wp-editor-area")){if("undefined"!=typeof tinymce){f=e.clone(a.snowfallTinyMCESettings),f.selector="#"+b.get("itemId")+"-tinymce",f.body_class=b.get("itemId")+"-tinymce",f.setup=function(a){a.on("change",function(){b.set({value:a.getContent()})})};try{tinyMCE.init(f),a.wpActiveEditor||(a.wpActiveEditor=b.get("itemId")+"-tinymce")}catch(g){}}if("undefined"!=typeof quicktags)try{quicktags({id:b.get("itemId")+"-tinymce",buttons:"strong,em,link,block,del,ins,img,ul,ol,li,code,more,close"}),a.wpActiveEditor||(a.wpActiveEditor=b.get("itemId")+"-tinymce")}catch(g){}"undefined"!=typeof jQuery&&jQuery(".wp-editor-wrap").on("click.wp-editor",function(){this.id&&(a.wpActiveEditor=this.id.slice(3,-5))})}},updateOrder:function(){e(this.collection.models).each(function(a){a.set({order:c("li#"+a.get("itemId")).index()})},this)},updateContent:function(){this.collection.sort(),c("#content").val(JSON.stringify(this.collection))}});new j}}(this,document,jQuery,Backbone,_);